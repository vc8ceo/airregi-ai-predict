# システムアーキテクチャ設計書

## 1. システム概要

### 1.1 目的
Airレジのジャーナル履歴データと天気予報情報を活用し、機械学習により店舗の営業日ごとの来店数と売上を高精度で予測するシステムを構築する。

### 1.2 主要機能
1. **データ収集・前処理**: POSデータと天気データの取得・変換
2. **特徴量エンジニアリング**: 予測に有効な特徴量の生成
3. **機械学習モデル**: 時系列予測モデルの訓練・評価
4. **予測API**: 次回営業日の来店数・売上予測を提供
5. **モニタリング**: 予測精度の継続的な評価

### 1.3 スコープ
- **対象店舗**: 単一店舗（将来的には複数店舗対応も可能な設計）
- **予測期間**: 翌営業日（1日先の予測）
- **予測項目**: 来店数（伝票数）、売上金額（税込）
- **データ更新頻度**: 日次バッチ処理

## 2. システムアーキテクチャ

### 2.1 全体構成図

```
┌─────────────────────────────────────────────────────────────┐
│                      データソース層                            │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐         ┌──────────────┐                 │
│  │  Airレジ       │         │ 天気予報API   │                 │
│  │  ジャーナル     │         │ (OpenWeather  │                 │
│  │  履歴CSV       │         │  /WeatherAPI) │                 │
│  └──────┬───────┘         └───────┬──────┘                 │
└─────────┼─────────────────────────┼────────────────────────┘
          │                             │
          ▼                             ▼
┌─────────────────────────────────────────────────────────────┐
│                    データ取り込み層                            │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐         ┌──────────────┐                 │
│  │ CSVインポータ │         │天気データ      │                 │
│  │ - エンコード   │         │フェッチャー    │                 │
│  │   変換        │         │ - 過去データ   │                 │
│  │ - バリデーション│        │ - 予報データ   │                 │
│  └──────┬───────┘         └───────┬──────┘                 │
└─────────┼─────────────────────────┼────────────────────────┘
          │                             │
          ▼                             ▼
┌─────────────────────────────────────────────────────────────┐
│                      データ処理層                              │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────────┐               │
│  │         データ前処理パイプライン            │               │
│  │  - 日次集計（来店数、売上）                 │               │
│  │  - 外れ値検出・処理                        │               │
│  │  - 欠損値補完                             │               │
│  │  - 特徴量エンジニアリング                   │               │
│  │    * 曜日、祝日、月、季節                  │               │
│  │    * ラグ特徴量（過去N日の実績）            │               │
│  │    * ローリング統計（移動平均等）            │               │
│  │    * 天気情報の統合                        │               │
│  └──────────────┬───────────────────────┘               │
└───────────────┼──────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────────┐
│                    データストレージ層                          │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │   Raw Data    │  │ Processed     │  │   Model      │    │
│  │   Store       │  │   Features    │  │   Store      │    │
│  │ (CSV/Parquet) │  │  (Parquet)    │  │ (Pickle/ONNX)│    │
│  └──────────────┘  └──────────────┘  └──────────────┘    │
└─────────────────────────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────────┐
│                     機械学習層                                │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────────┐               │
│  │         モデル訓練パイプライン              │               │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐│              │
│  │  │ 来店数     │  │  売上     │  │ アンサンブル││              │
│  │  │ 予測モデル │  │ 予測モデル│  │  モデル   ││              │
│  │  │           │  │          │  │           ││              │
│  │  │・LightGBM │  │・LightGBM│  │・スタッキング││             │
│  │  │・Prophet  │  │・Prophet │  │・重み付き   ││             │
│  │  │・LSTM     │  │・LSTM    │  │  平均      ││             │
│  │  └──────────┘  └──────────┘  └──────────┘│              │
│  │                                              │               │
│  │  - ハイパーパラメータチューニング              │               │
│  │  - クロスバリデーション                       │               │
│  │  - モデル評価（MAE, RMSE, MAPE等）          │               │
│  └──────────────────────────────────────────┘               │
└───────────────┬──────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────────┐
│                      API層                                    │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────────┐               │
│  │          FastAPI RESTful API              │               │
│  │                                            │               │
│  │  GET  /predict/next-day                   │               │
│  │  GET  /predict/date/{date}                │               │
│  │  POST /train                              │               │
│  │  GET  /metrics                            │               │
│  │  GET  /health                             │               │
│  └──────────────────────────────────────────┘               │
└─────────────────────────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────────┐
│                    アプリケーション層                          │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │  Web UI       │  │ バッチジョブ   │  │ モニタリング  │    │
│  │ (Streamlit)   │  │ (Scheduler)   │  │ (Logging)    │    │
│  └──────────────┘  └──────────────┘  └──────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 技術スタック

#### プログラミング言語
- **Python 3.10+**: 主要な開発言語

#### データ処理
- **pandas**: データ操作・前処理
- **numpy**: 数値計算
- **polars**: 高速データ処理（オプション）

#### 機械学習
- **scikit-learn**: 前処理・評価指標
- **LightGBM**: 勾配ブースティング
- **Prophet**: 時系列予測（Facebook製）
- **TensorFlow/PyTorch**: ディープラーニング（LSTM）
- **optuna**: ハイパーパラメータチューニング

#### API・Web
- **FastAPI**: REST APIフレームワーク
- **uvicorn**: ASGIサーバー
- **Streamlit**: Webダッシュボード（オプション）

#### データストレージ
- **CSV**: 生データの保存
- **Parquet**: 処理済みデータの効率的保存
- **Pickle/Joblib**: モデルのシリアライズ

#### 外部API
- **OpenWeatherMap API**: 天気情報取得
- **WeatherAPI**: 代替天気情報ソース

#### ユーティリティ
- **python-dotenv**: 環境変数管理
- **pydantic**: データバリデーション
- **loguru**: ロギング
- **pytest**: テスティング

## 3. データフロー

### 3.1 学習フェーズ

```
1. データ収集
   ↓
2. CSVインポート（CP932 → UTF-8変換）
   ↓
3. データ検証・クレンジング
   ↓
4. 日次集計（伝票No単位で来店数・売上を算出）
   ↓
5. 天気データ取得・結合
   ↓
6. 特徴量エンジニアリング
   ↓
7. 学習データ・検証データ分割
   ↓
8. モデル訓練
   ↓
9. モデル評価・選択
   ↓
10. モデル保存
```

### 3.2 予測フェーズ

```
1. 最新データ読み込み
   ↓
2. 予測日の天気予報取得
   ↓
3. 特徴量生成
   ↓
4. 保存済みモデルのロード
   ↓
5. 予測実行
   ↓
6. 予測結果の返却・保存
```

### 3.3 日次運用フロー

```
毎日 AM 6:00
  ↓
1. 前日の実績データをインポート
  ↓
2. 実績データをデータベースに追加
  ↓
3. 直近N日のデータで再学習（週1回）
  ↓
4. 翌営業日の天気予報を取得
  ↓
5. 翌営業日の来店数・売上を予測
  ↓
6. 予測結果をAPI経由で提供
  ↓
7. ダッシュボード更新
```

## 4. モジュール構成

### 4.1 ディレクトリ構造

```
airregi_ai_predict/
├── config/                    # 設定ファイル
│   ├── config.yaml           # システム設定
│   ├── model_config.yaml     # モデルパラメータ
│   └── .env                  # 環境変数（API Key等）
├── data/                      # データディレクトリ
│   ├── raw/                  # 生データ
│   │   ├── journal/          # ジャーナル履歴CSV
│   │   └── weather/          # 天気データ
│   ├── processed/            # 処理済みデータ
│   │   ├── daily_aggregated/ # 日次集計データ
│   │   └── features/         # 特徴量データ
│   └── models/               # 保存済みモデル
│       ├── visitor_count/    # 来店数予測モデル
│       └── sales/            # 売上予測モデル
├── docs/                      # ドキュメント
│   ├── 01_data_dictionary.md
│   ├── 02_system_architecture.md
│   ├── 03_data_pipeline.md
│   ├── 04_ml_models.md
│   └── 05_api_specification.md
├── notebooks/                 # Jupyter Notebooks
│   ├── 01_eda.ipynb          # 探索的データ分析
│   ├── 02_feature_engineering.ipynb
│   └── 03_model_experiments.ipynb
├── src/                       # ソースコード
│   ├── __init__.py
│   ├── data/                 # データ処理
│   │   ├── __init__.py
│   │   ├── loader.py         # データ読み込み
│   │   ├── preprocessor.py   # 前処理
│   │   ├── aggregator.py     # 集計処理
│   │   └── validator.py      # データ検証
│   ├── features/             # 特徴量エンジニアリング
│   │   ├── __init__.py
│   │   ├── temporal.py       # 時系列特徴量
│   │   ├── lag.py            # ラグ特徴量
│   │   └── rolling.py        # ローリング特徴量
│   ├── external/             # 外部API連携
│   │   ├── __init__.py
│   │   ├── weather_api.py    # 天気API
│   │   └── holiday.py        # 祝日判定
│   ├── models/               # 機械学習モデル
│   │   ├── __init__.py
│   │   ├── base_model.py     # 基底クラス
│   │   ├── lightgbm_model.py # LightGBMモデル
│   │   ├── prophet_model.py  # Prophetモデル
│   │   ├── lstm_model.py     # LSTMモデル
│   │   └── ensemble.py       # アンサンブル
│   ├── training/             # モデル訓練
│   │   ├── __init__.py
│   │   ├── trainer.py        # 訓練ロジック
│   │   ├── evaluator.py      # 評価ロジック
│   │   └── tuner.py          # ハイパーパラメータチューニング
│   ├── api/                  # API
│   │   ├── __init__.py
│   │   ├── main.py           # FastAPIアプリ
│   │   ├── routes.py         # エンドポイント定義
│   │   ├── schemas.py        # リクエスト/レスポンススキーマ
│   │   └── predictor.py      # 予測ロジック
│   └── utils/                # ユーティリティ
│       ├── __init__.py
│       ├── logger.py         # ロギング
│       ├── config.py         # 設定読み込み
│       └── metrics.py        # 評価指標
├── tests/                     # テストコード
│   ├── test_data/
│   ├── test_features/
│   ├── test_models/
│   └── test_api/
├── scripts/                   # スクリプト
│   ├── download_weather.py   # 天気データダウンロード
│   ├── train_model.py        # モデル訓練スクリプト
│   ├── predict_daily.py      # 日次予測スクリプト
│   └── evaluate_model.py     # モデル評価スクリプト
├── .gitignore
├── requirements.txt          # 依存パッケージ
├── setup.py
└── README.md
```

## 5. セキュリティとデータガバナンス

### 5.1 データ保護
- APIキーは環境変数または`.env`ファイルで管理（Gitには含めない）
- 個人情報（スタッフ名等）は匿名化を検討
- データバックアップの定期実行

### 5.2 アクセス制御
- API認証の実装（API Key / JWT）
- ロールベースアクセス制御（将来的に）

## 6. スケーラビリティと拡張性

### 6.1 複数店舗対応
- 店舗IDをキーとしたマルチテナント設計
- 店舗別モデルの訓練・管理

### 6.2 リアルタイム予測
- ストリーミングデータ処理への対応
- オンライン学習の実装

### 6.3 新機能追加
- 商品カテゴリ別売上予測
- 時間帯別来店数予測
- 在庫最適化への応用

## 7. 運用とモニタリング

### 7.1 パフォーマンスモニタリング
- 予測精度の継続的追跡（MAE, RMSE, MAPE）
- モデルドリフト検出

### 7.2 アラート
- 予測精度の大幅な低下を検知
- データ異常（欠損、外れ値）の検知

### 7.3 再学習戦略
- 週次での増分学習
- 月次での全データ再学習
- 季節性を考慮した年次更新

## 8. 開発・デプロイメント

### 8.1 開発環境
- Python仮想環境（venv / conda）
- Jupyter Notebookでの探索的分析

### 8.2 本番環境（将来）
- Dockerコンテナ化
- クラウドデプロイ（AWS/GCP/Azure）
- CI/CDパイプライン

## 9. 成功指標（KPI）

### 9.1 予測精度
- **来店数予測**: MAPE < 15%
- **売上予測**: MAPE < 20%

### 9.2 システム稼働率
- API可用性: 99.5%以上

### 9.3 ビジネス価値
- 在庫ロス削減率: 20%
- 人員配置最適化: スタッフ配置の効率化

## 更新履歴

| 日付 | バージョン | 更新内容 | 作成者 |
|------|------------|----------|--------|
| 2025-10-13 | 1.0 | 初版作成 | Claude |
